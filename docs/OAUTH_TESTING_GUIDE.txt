================================================================================
GITHUB & GOOGLE OAUTH - TESTING GUIDE
================================================================================
Date: December 16, 2025
Status: âœ… FULLY IMPLEMENTED

================================================================================
IMPLEMENTATION SUMMARY
================================================================================

âœ… GitHub OAuth:
   - User authentication via GitHub
   - Creates new account OR links to existing account
   - Stores: username, avatar, bio, stats, encrypted token
   - Generates JWT token for immediate login
   - Auto-redirects to dashboard

âœ… Google OAuth:
   - User authentication via Google
   - Creates new account OR links to existing account  
   - Stores: name, email, picture, encrypted token
   - Generates JWT token for immediate login
   - Auto-redirects to dashboard

âœ… Database Integration:
   - Student records created/updated automatically
   - Profile fields populated from OAuth data
   - Encrypted token storage (AES-256-GCM)
   - Email verification status tracked

âœ… Frontend Integration:
   - Detects OAuth callback with token
   - Stores JWT in localStorage
   - Shows success toast notification
   - Redirects to dashboard
   - Displays user data in profile


================================================================================
HOW TO TEST - GITHUB OAUTH
================================================================================

STEP 1: Start Backend Server
   Terminal 1:
   $ cd backend
   $ node server.js
   
   Expected Output:
   âœ… Connected to MongoDB Atlas
   ðŸš€ EvolvEd backend running on port 5001
   ðŸ”Œ WebSocket server ready

STEP 2: Start Frontend Server
   Terminal 2:
   $ npm run dev
   
   Expected Output:
   VITE v... ready in ...ms
   âžœ Local: http://localhost:8080/

STEP 3: Open Login Page
   Browser:
   http://localhost:8080/student/login

STEP 4: Click "Continue with GitHub"
   - Should redirect to: https://github.com/login/oauth/authorize
   - NOT to your frontend login page
   - Should show GitHub authorization page

STEP 5: Authorize Application
   - Click "Authorize" button on GitHub
   - GitHub redirects back to: http://localhost:5001/api/github/callback

STEP 6: Backend Processing (check terminal logs)
   Expected logs:
   ðŸ”µ [GitHub OAuth] /callback endpoint hit
   ðŸ”µ [GitHub OAuth] Authorization code received: true
   ðŸ”µ [GitHub OAuth] Exchanging authorization code for access token...
   âœ… [GitHub OAuth] Access token received
   ðŸ”µ [GitHub OAuth] Fetching user profile from GitHub API...
   âœ… [GitHub OAuth] GitHub profile fetched successfully
   âœ… [GitHub OAuth] Username: YourGitHubUsername
   ðŸ”µ [GitHub OAuth] Fetching user emails...
   âœ… [GitHub OAuth] Emails fetched: 1
   ðŸ”µ [GitHub OAuth] Extracted email: your@email.com
   
   EITHER (new user):
   ðŸ”µ [GitHub OAuth] Creating new user...
   âœ… [GitHub OAuth] New user created: your@email.com
   
   OR (existing user):
   âœ… [GitHub OAuth] Existing user found: your@email.com
   âœ… [GitHub OAuth] User updated successfully
   
   âœ… [GitHub OAuth] JWT token generated
   ðŸ”µ [GitHub OAuth] Redirecting to frontend
   âœ… [GitHub OAuth] OAuth flow complete - redirecting to FRONTEND

STEP 7: Frontend Redirect
   Browser automatically redirects to:
   http://localhost:8080/student/login?githubconnected=true&token=JWT_TOKEN&username=YourUsername
   
   Then immediately redirects to:
   http://localhost:8080/student/dashboard

STEP 8: Verify Login Success
   âœ… Toast notification: "GitHub Login Successful!"
   âœ… Dashboard loads with user data
   âœ… localStorage contains:
      - token: JWT_TOKEN
      - userType: student

STEP 9: Check Profile Data
   Navigate to: http://localhost:8080/student/profile
   
   Should display:
   âœ… Avatar from GitHub
   âœ… GitHub username
   âœ… GitHub URL
   âœ… Email from GitHub
   âœ… Location (if set in GitHub)
   âœ… Bio (if set in GitHub)

STEP 10: Verify Database Entry
   MongoDB:
   - Find student by email
   - Check fields:
     * name: Your GitHub name
     * email: Your GitHub email
     * avatarUrl: GitHub avatar URL
     * githubUrl: https://github.com/YourUsername
     * githubAuth.githubId: Your GitHub ID
     * githubAuth.username: Your GitHub username
     * githubAuth.encryptedAccessToken: (encrypted string)
     * githubAuth.connectedAt: (timestamp)
     * githubAuth.authType: "oauth"
     * githubStats.username: Your GitHub username
     * githubStats.totalRepos: Number of public repos
     * oauthProvider: "github"
     * emailVerified: true (if GitHub email verified)


================================================================================
HOW TO TEST - GOOGLE OAUTH
================================================================================

STEP 1-2: Same as GitHub (start servers)

STEP 3: Open Login Page
   http://localhost:8080/student/login

STEP 4: Click "Continue with Google"
   - Should redirect to: https://accounts.google.com/o/oauth2/v2/auth
   - Should show Google sign-in page

STEP 5: Sign In with Google
   - Select your Google account
   - Click "Continue" or "Allow"
   - Google redirects back to: http://localhost:5001/api/google/callback

STEP 6: Backend Processing (check terminal logs)
   Expected logs:
   ðŸŸ¢ [Google OAuth] /callback endpoint hit
   ðŸŸ¢ [Google OAuth] Authorization code received: true
   ðŸŸ¢ [Google OAuth] Exchanging code for access token...
   âœ… [Google OAuth] Access token received
   ðŸŸ¢ [Google OAuth] Fetching Google user profile...
   âœ… [Google OAuth] Google profile fetched: your@gmail.com
   
   EITHER (new user):
   ðŸŸ¢ [Google OAuth] Creating new user...
   âœ… [Google OAuth] New user created: your@gmail.com
   
   OR (existing user):
   âœ… [Google OAuth] Existing user found: your@gmail.com
   âœ… [Google OAuth] User updated successfully
   
   âœ… [Google OAuth] JWT token generated
   ðŸŸ¢ [Google OAuth] Redirecting to frontend with success flag

STEP 7: Frontend Redirect
   Browser automatically redirects to:
   http://localhost:8080/student/login?googleconnected=true&token=JWT_TOKEN&email=your@gmail.com
   
   Then immediately redirects to:
   http://localhost:8080/student/dashboard

STEP 8: Verify Login Success
   âœ… Toast notification: "Google Login Successful!"
   âœ… Dashboard loads
   âœ… localStorage contains token

STEP 9: Check Profile Data
   Navigate to: http://localhost:8080/student/profile
   
   Should display:
   âœ… Avatar from Google
   âœ… Name from Google
   âœ… Email from Google

STEP 10: Verify Database Entry
   MongoDB:
   - Find student by email
   - Check fields:
     * name: Your Google name
     * email: Your Google email
     * avatarUrl: Google profile picture URL
     * googleAuth.googleId: Your Google ID
     * googleAuth.email: Your Google email
     * googleAuth.name: Your Google name
     * googleAuth.picture: Google picture URL
     * googleAuth.encryptedAccessToken: (encrypted string)
     * googleAuth.connectedAt: (timestamp)
     * oauthProvider: "google"
     * emailVerified: true (Google emails always verified)


================================================================================
WHAT DATA IS STORED IN DATABASE
================================================================================

GITHUB OAUTH CREATES/UPDATES:

Student Document:
{
  name: "John Doe",                          // From GitHub profile
  firstName: "John",                         // Extracted from name
  lastName: "Doe",                           // Extracted from name
  email: "john@example.com",                 // From GitHub emails
  password: "random_hash",                   // Random for OAuth users
  avatarUrl: "https://avatars.github...",    // GitHub avatar
  githubUrl: "https://github.com/johndoe",   // GitHub profile URL
  location: "San Francisco",                 // From GitHub profile
  portfolioUrl: "https://johndoe.dev",       // From GitHub blog field
  summary: "Software Developer",             // From GitHub bio
  oauthProvider: "github",                   // Primary OAuth provider
  emailVerified: true,                       // If GitHub email verified
  
  githubAuth: {
    githubId: "12345678",                    // GitHub user ID
    username: "johndoe",                     // GitHub username
    avatarUrl: "https://avatars...",         // GitHub avatar
    encryptedAccessToken: "iv:tag:data",     // Encrypted OAuth token
    connectedAt: "2025-12-16T...",           // When OAuth completed
    authType: "oauth",                       // Connection method
    lastVerifiedAt: "2025-12-16T...",        // Last verification
  },
  
  githubStats: {
    username: "johndoe",                     // GitHub username
    avatarUrl: "https://avatars...",         // GitHub avatar
    bio: "Software Developer",               // GitHub bio
    totalRepos: 42,                          // Public repositories count
    followers: 123,                          // GitHub followers
    following: 45,                           // GitHub following
    publicGists: 5,                          // Public gists count
    createdAt: "2015-01-01T...",            // GitHub account creation
    topLanguages: [],                        // (populated by background job)
    topRepos: [],                            // (populated by background job)
    activityScore: 0,                        // (calculated by background job)
    lastSyncedAt: "2025-12-16T...",         // Last data sync
  }
}

GOOGLE OAUTH CREATES/UPDATES:

Student Document:
{
  name: "Jane Smith",                        // From Google profile
  firstName: "Jane",                         // Extracted from name
  lastName: "Smith",                         // Extracted from name
  email: "jane@gmail.com",                   // From Google account
  password: "random_hash",                   // Random for OAuth users
  avatarUrl: "https://lh3.google...",        // Google profile picture
  oauthProvider: "google",                   // Primary OAuth provider
  emailVerified: true,                       // Always true for Google
  
  googleAuth: {
    googleId: "987654321",                   // Google user ID
    email: "jane@gmail.com",                 // Google email
    name: "Jane Smith",                      // Google display name
    picture: "https://lh3.google...",        // Google profile picture
    encryptedAccessToken: "iv:tag:data",     // Encrypted OAuth token
    connectedAt: "2025-12-16T...",           // When OAuth completed
    lastLoginAt: "2025-12-16T...",           // Last Google login
  }
}


================================================================================
DATA FLOW DIAGRAM
================================================================================

GITHUB OAUTH FLOW:

1. User clicks "Continue with GitHub"
   â†“
2. Frontend: window.location.href = "http://localhost:5001/api/github/login"
   â†“
3. Backend: GET /api/github/login
   - Generates state token (CSRF protection)
   - Stores state in cookie
   - Redirects to: https://github.com/login/oauth/authorize
   â†“
4. GitHub: User authorizes app
   â†“
5. GitHub redirects: http://localhost:5001/api/github/callback?code=xxx&state=yyy
   â†“
6. Backend: GET /api/github/callback
   - Validates state (CSRF check)
   - Exchanges code for access token
   - Fetches user profile: GET https://api.github.com/user
   - Fetches user emails: GET https://api.github.com/user/emails
   - Extracts profile data (name, email, avatar, bio, etc.)
   - Checks if user exists in database:
     * By GitHub ID: githubAuth.githubId
     * By email: email field
   - IF EXISTS:
     * Updates githubAuth object
     * Updates githubStats object
     * Updates profile fields (if empty)
     * Saves student
   - IF NOT EXISTS:
     * Creates new Student document
     * Sets all profile fields
     * Hashes random password
     * Sets oauthProvider = "github"
     * Saves student
   - Generates JWT token (7 day expiry)
   - Redirects to: http://localhost:8080/student/login?githubconnected=true&token=JWT
   â†“
7. Frontend: StudentLogin.tsx useEffect
   - Detects githubconnected=true and token param
   - Saves token to localStorage
   - Shows success toast
   - Navigates to: /student/dashboard
   â†“
8. Frontend: StudentDashboard.tsx
   - Loads with authenticated user
   - Makes API call: GET /api/students/profile
   - Backend returns student data with:
     * Basic profile (name, email, avatar)
     * GitHub data (username, stats, repos)
     * All other profile fields
   - Dashboard displays user information
   â†“
9. User clicks Profile
   - Navigate to: /student/profile
   - Shows complete profile with GitHub data:
     * Avatar from GitHub
     * GitHub URL
     * Location from GitHub
     * Bio from GitHub
     * All editable fields


================================================================================
SECURITY FEATURES IMPLEMENTED
================================================================================

âœ… CSRF Protection:
   - State parameter generated and validated
   - Stored in httpOnly cookie
   - Checked on callback

âœ… Token Encryption:
   - OAuth tokens encrypted with AES-256-GCM
   - Encryption key stored in environment variable
   - Unique IV for each encryption
   - Authentication tag for integrity

âœ… Secure Cookie Settings:
   - httpOnly: true (no JavaScript access)
   - sameSite: 'lax' (CSRF protection)
   - secure: true (in production, HTTPS only)
   - maxAge: 10 minutes (expires after OAuth flow)

âœ… JWT Authentication:
   - 7 day expiration
   - Signed with secret key
   - Contains user ID and role
   - Used for all subsequent API requests

âœ… Password Handling:
   - OAuth users get random password (32 bytes)
   - Hashed with bcrypt (10 rounds)
   - Users can't use password login (OAuth only)

âœ… Data Privacy:
   - Only requested OAuth scopes used
   - Users can disconnect OAuth (future feature)
   - Encrypted tokens never exposed in API


================================================================================
TROUBLESHOOTING
================================================================================

ISSUE: "No email found in your GitHub account"
SOLUTION: 
   - Add a verified email to your GitHub account
   - Settings â†’ Emails â†’ Add email address
   - Verify the email via GitHub's verification link
   - Try OAuth flow again

ISSUE: Backend returns 404 for /api/github/login
SOLUTION:
   - Check backend is running on port 5001
   - Check routes are registered in server.js
   - Look for errors in backend terminal
   - Restart backend server

ISSUE: Redirects to frontend login instead of GitHub
SOLUTION:
   - Clear browser cache and cookies
   - Try in incognito/private window
   - Check network tab for actual redirect URL
   - Verify backend logs show redirect to GitHub

ISSUE: OAuth completes but no dashboard redirect
SOLUTION:
   - Check browser console for errors
   - Verify token is in URL params
   - Check localStorage for 'token' key
   - Look for frontend JavaScript errors

ISSUE: "Invalid OAuth state" error
SOLUTION:
   - Cookies might be blocked
   - Check browser cookie settings
   - Try different browser
   - Check sameSite cookie policy

ISSUE: Token encryption error
SOLUTION:
   - Verify GITHUB_TOKEN_ENCRYPTION_KEY in .env
   - Must be 64 hex characters (32 bytes)
   - Generate new key: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   - Same for GOOGLE_TOKEN_ENCRYPTION_KEY

ISSUE: Database not updating
SOLUTION:
   - Check MongoDB connection in backend logs
   - Verify MONGODB_URI in .env
   - Check database permissions
   - Look for validation errors in logs


================================================================================
NEXT STEPS (FUTURE ENHANCEMENTS)
================================================================================

ðŸ”„ Background Sync Job:
   - Fetch repositories from GitHub
   - Analyze languages and technologies
   - Create project entries automatically
   - Extract skills from repositories
   - Calculate activity score
   - Update stats daily/weekly

ðŸ”„ Advanced GitHub Integration:
   - Display top repositories on profile
   - Show contribution graph
   - Display programming languages chart
   - Show recent commits and activity
   - Display organization memberships

ðŸ”„ Profile Completion:
   - After Google OAuth, ask for GitHub handle
   - Show progress bar for profile completion
   - Suggest adding missing fields
   - Reward points for complete profile

ðŸ”„ OAuth Management:
   - Allow users to disconnect OAuth
   - Re-sync GitHub data manually
   - View OAuth connection status
   - Manage connected accounts

ðŸ”„ Enhanced Security:
   - Token refresh implementation
   - Periodic token validation
   - OAuth scope management
   - Two-factor authentication


================================================================================
SUCCESS CRITERIA CHECKLIST
================================================================================

âœ… GitHub OAuth Flow:
   [âœ…] User clicks GitHub button
   [âœ…] Redirects to GitHub authorization
   [âœ…] User authorizes app
   [âœ…] Callback receives code
   [âœ…] Code exchanged for token
   [âœ…] User profile fetched
   [âœ…] User emails fetched
   [âœ…] Profile data extracted
   [âœ…] User created/updated in database
   [âœ…] JWT token generated
   [âœ…] Redirect to frontend with token
   [âœ…] Frontend stores token
   [âœ…] User logged in automatically
   [âœ…] Dashboard loads
   [âœ…] Profile shows GitHub data

âœ… Google OAuth Flow:
   [âœ…] User clicks Google button
   [âœ…] Redirects to Google authorization
   [âœ…] User selects account
   [âœ…] Callback receives code
   [âœ…] Code exchanged for token
   [âœ…] User profile fetched
   [âœ…] Profile data extracted
   [âœ…] User created/updated in database
   [âœ…] JWT token generated
   [âœ…] Redirect to frontend with token
   [âœ…] Frontend stores token
   [âœ…] User logged in automatically
   [âœ…] Dashboard loads
   [âœ…] Profile shows Google data

âœ… Database Integration:
   [âœ…] Student documents created
   [âœ…] GitHub auth data stored
   [âœ…] Google auth data stored
   [âœ…] Tokens encrypted
   [âœ…] Profile fields populated
   [âœ…] Email verification tracked
   [âœ…] OAuth provider recorded

âœ… Security:
   [âœ…] CSRF protection (state validation)
   [âœ…] Token encryption (AES-256-GCM)
   [âœ…] Secure cookies (httpOnly, sameSite)
   [âœ…] JWT authentication (7 day expiry)
   [âœ…] Password hashing (bcrypt)


================================================================================
END OF TESTING GUIDE
================================================================================

All systems operational! ðŸš€
OAuth implementation complete and fully functional.

For questions or issues, check:
- Backend logs: /tmp/backend-oauth.log
- Frontend console: Browser DevTools
- Database: MongoDB Atlas dashboard
- Documentation: /docs/GITHUB_DATA_EXTRACTION.txt
